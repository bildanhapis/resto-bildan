<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resto Bildan - Ocean Blue Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0ea5e9',   /* Sky 500 */
                        secondary: '#1e40af', /* Blue 800 */
                        darkbg: '#0f172a',
                        darkcard: '#1e293b',
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, #38bdf8, #1e40af); border-radius: 10px; }
        
        .bg-gradient-brand { background: linear-gradient(90deg, #38bdf8 0%, #2563eb 100%); }
        .text-gradient-brand { 
            background: linear-gradient(90deg, #0284c7 0%, #1e3a8a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .dark .text-gradient-brand { 
            background: linear-gradient(90deg, #38bdf8 0%, #60a5fa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .scale-in { animation: scaleIn 0.3s ease-out forwards; opacity: 0; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-darkbg dark:text-gray-100 pb-24 transition-colors duration-300 font-sans">

    <header class="bg-gradient-brand p-4 sticky top-0 z-40 shadow-lg text-white transition-all">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="utensils" class="w-6 h-6 text-white"></i> Resto Bildan
            </h1>
            
            <div class="flex items-center gap-3">
                <div id="user-section" class="hidden md:flex items-center gap-2 mr-2 bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm">
                    <i data-lucide="user" class="w-4 h-4"></i>
                    <span id="user-name" class="text-xs font-bold truncate max-w-[100px]">Tamu</span>
                </div>

                <button id="btn-auth" onclick="openAuthModal()" class="text-xs bg-white text-blue-600 px-3 py-1.5 rounded-full font-bold hover:bg-blue-50 transition shadow-sm">
                    Masuk
                </button>

                <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-white/20 transition text-white">
                    <i data-lucide="moon" id="icon-theme" class="w-5 h-5"></i>
                </button>
                
                <div class="relative cursor-pointer p-2 rounded-full hover:bg-white/20 transition text-white" onclick="openCart()">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    <span id="cart-badge" class="hidden absolute top-0 right-0 bg-yellow-400 text-blue-900 text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full shadow-md border-2 border-transparent">0</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 space-y-6">

        <section class="bg-white dark:bg-darkcard p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                <h2 class="text-base font-bold flex items-center gap-2 text-blue-600 dark:text-sky-400">
                    <i data-lucide="sparkles" class="w-4 h-4"></i> Rekomendasi AI
                </h2>
                <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                    <button onclick="setWeather('sunny')" id="btn-sunny" class="px-3 py-1.5 rounded-md text-xs font-medium flex gap-1 items-center bg-white dark:bg-slate-700 shadow-sm text-yellow-600 dark:text-yellow-400 transition">
                        <i data-lucide="sun" class="w-3 h-3"></i> Panas
                    </button>
                    <button onclick="setWeather('rainy')" id="btn-rainy" class="px-3 py-1.5 rounded-md text-xs font-medium flex gap-1 items-center text-slate-500 dark:text-slate-400 transition">
                        <i data-lucide="cloud-rain" class="w-3 h-3"></i> Hujan
                    </button>
                </div>
            </div>
            <p id="ai-message" class="text-xs text-slate-500 dark:text-slate-400 mb-4">Memuat rekomendasi...</p>
            <div id="ai-container" class="grid grid-cols-3 gap-3"></div>
        </section>

        <section>
            <div class="sticky top-[72px] z-30 py-3 bg-slate-50 dark:bg-darkbg -mx-4 px-4 backdrop-blur-sm bg-opacity-95">
                 <div class="relative mb-3">
                    <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="search-input" placeholder="Cari menu..." 
                        class="w-full pl-9 pr-4 py-2 border-none rounded-xl bg-white dark:bg-darkcard shadow-sm focus:ring-2 focus:ring-blue-400 dark:text-white transition text-sm">
                </div>
                <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                    <button onclick="filterCategory('All')" class="cat-btn bg-gradient-brand text-white px-4 py-2 rounded-full text-xs font-bold shadow-md shadow-blue-200 dark:shadow-none transition transform hover:scale-105 whitespace-nowrap">Semua</button>
                    <button onclick="filterCategory('Nasi')" class="cat-btn bg-white dark:bg-darkcard text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-full text-xs font-medium whitespace-nowrap transition hover:border-blue-400 hover:text-blue-500">Nasi</button>
                    <button onclick="filterCategory('Mie')" class="cat-btn bg-white dark:bg-darkcard text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-full text-xs font-medium whitespace-nowrap transition hover:border-blue-400 hover:text-blue-500">Mie</button>
                    <button onclick="filterCategory('Western')" class="cat-btn bg-white dark:bg-darkcard text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-full text-xs font-medium whitespace-nowrap transition hover:border-blue-400 hover:text-blue-500">Western</button>
                    <button onclick="filterCategory('Snack')" class="cat-btn bg-white dark:bg-darkcard text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-full text-xs font-medium whitespace-nowrap transition hover:border-blue-400 hover:text-blue-500">Cemilan</button>
                    <button onclick="filterCategory('Minuman')" class="cat-btn bg-white dark:bg-darkcard text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-full text-xs font-medium whitespace-nowrap transition hover:border-blue-400 hover:text-blue-500">Minuman</button>
                </div>
            </div>

            <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-2"></div>
        </section>
    </main>

    <div id="cart-overlay" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-darkcard border-t dark:border-slate-800 shadow-[0_-8px_30px_rgba(0,0,0,0.15)] p-4 transform translate-y-full transition-transform duration-300 z-50 rounded-t-3xl">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2 group cursor-pointer" onclick="toggleCartDrawer()">
                    <h3 class="font-bold text-base dark:text-white flex items-center gap-2">
                        <i data-lucide="shopping-bag" class="text-blue-600 dark:text-sky-400 w-5 h-5"></i> Pesanan
                    </h3>
                    <span id="cart-total-badge" class="text-xs font-bold bg-slate-100 dark:bg-slate-700 text-blue-600 dark:text-sky-400 px-2 py-1 rounded-full">0</span>
                    <i data-lucide="chevron-up" id="cart-chevron" class="w-5 h-5 text-slate-400 group-hover:text-blue-500 transition-transform duration-300"></i>
                </div>
                
                <button onclick="clearCart()" class="text-xs text-red-500 font-bold hover:text-red-700 flex items-center gap-1 bg-red-50 dark:bg-red-900/20 px-3 py-1.5 rounded-full transition">
                    <i data-lucide="trash-2" class="w-3 h-3"></i> Batalkan
                </button>
            </div>

            <div id="cart-items" class="max-h-60 overflow-y-auto mb-4 space-y-3 hidden scrollbar-hide"></div>
            
            <div class="flex justify-between items-center border-t border-dashed border-slate-200 dark:border-slate-700 pt-4 mt-2">
                <div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Total Bayar</p>
                    <p id="total-price" class="text-xl font-extrabold text-gradient-brand">Rp 0</p>
                </div>
                <button onclick="openPaymentModal()" class="bg-gradient-brand text-white px-6 py-3 rounded-full font-bold hover:opacity-90 shadow-lg shadow-blue-500/30 transition transform active:scale-95 flex items-center gap-2 text-sm">
                    Checkout <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="auth-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-[70] p-4 backdrop-blur-md transition-opacity duration-300">
        <div class="bg-white dark:bg-darkcard w-full max-w-sm rounded-3xl p-8 shadow-2xl transform transition-all scale-95 opacity-0 text-center relative" id="auth-box">
            
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-white transition">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <div class="mb-6">
                <div class="bg-blue-100 dark:bg-slate-700 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i id="auth-icon" data-lucide="log-in" class="w-8 h-8 text-blue-600 dark:text-sky-400"></i>
                </div>
                <h3 id="auth-title" class="text-2xl font-bold dark:text-white text-slate-800">Masuk Akun</h3>
                <p id="auth-subtitle" class="text-sm text-slate-500 dark:text-slate-400 mt-2">Silakan masuk untuk mulai memesan.</p>
            </div>
            
            <div class="space-y-4">
                <div class="text-left">
                    <label class="text-xs font-bold text-slate-500 dark:text-slate-400 ml-2">Username</label>
                    <div class="relative mt-1">
                        <i data-lucide="user" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                        <input type="text" id="auth-name-input" placeholder="Contoh: Bildan" 
                            class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition">
                    </div>
                </div>

                <div class="text-left">
                    <label class="text-xs font-bold text-slate-500 dark:text-slate-400 ml-2">Password</label>
                    <div class="relative mt-1">
                        <i data-lucide="lock" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                        <input type="password" id="auth-pass-input" placeholder="******" 
                            class="w-full pl-10 pr-10 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition">
                        
                        <button type="button" onclick="togglePasswordVisibility()" class="absolute right-3 top-2.5 text-slate-400 hover:text-blue-500 transition">
                            <i id="eye-icon" data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                
                <button onclick="handleAuthAction()" id="btn-submit-auth" class="w-full bg-gradient-brand text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/40 hover:opacity-90 transition active:scale-95 mt-2">
                    Masuk Sekarang
                </button>
                
                <div class="text-sm text-slate-500 dark:text-slate-400 mt-4">
                    <span id="auth-switch-text">Belum punya akun?</span>
                    <button onclick="toggleAuthMode()" class="text-blue-600 dark:text-sky-400 font-bold hover:underline ml-1" id="auth-switch-btn">
                        Buat Akun
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="payment-modal" class="fixed inset-0 bg-black/60 hidden items-end sm:items-center justify-center z-[60] p-4 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white dark:bg-darkcard w-full max-w-md rounded-3xl p-6 shadow-2xl transform transition-all scale-95 opacity-0" id="payment-box">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100 dark:border-slate-700">
                <h3 class="text-lg font-bold dark:text-white text-blue-900">Pembayaran</h3>
                <button onclick="closePaymentModal()" class="text-slate-400 hover:text-blue-500 transition bg-slate-50 dark:bg-slate-800 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-4 p-4 border border-slate-200 dark:border-slate-700 bg-white dark:bg-darkcard rounded-2xl cursor-pointer hover:border-blue-500 dark:hover:border-sky-500 transition group relative overflow-hidden">
                    <input type="radio" name="payment" value="Tunai (COD)" class="w-5 h-5 text-blue-600 accent-blue-600" checked>
                    <div class="flex-1 relative z-10">
                        <span class="block font-bold dark:text-white text-sm group-hover:text-blue-600 flex items-center gap-2"><i data-lucide="banknote" class="w-4 h-4"></i> Tunai (COD)</span>
                        <span class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Bayar saat pesanan sampai</span>
                    </div>
                </label>
                <label class="flex items-center gap-4 p-4 border border-slate-200 dark:border-slate-700 bg-white dark:bg-darkcard rounded-2xl cursor-pointer hover:border-blue-500 dark:hover:border-sky-500 transition group relative overflow-hidden">
                    <input type="radio" name="payment" value="QRIS" class="w-5 h-5 text-blue-600 accent-blue-600">
                    <div class="flex-1 relative z-10">
                        <span class="block font-bold dark:text-white text-sm group-hover:text-blue-600 flex items-center gap-2"><i data-lucide="qr-code" class="w-4 h-4"></i> QRIS / E-Wallet</span>
                        <span class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Scan kode QR</span>
                    </div>
                </label>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl mb-6 flex justify-between items-center">
                <span class="text-sm font-medium text-slate-600 dark:text-slate-400">Total Tagihan</span>
                <span id="modal-total-price" class="font-extrabold text-lg text-blue-700 dark:text-sky-400">Rp 0</span>
            </div>
            <div class="flex gap-3">
                <button onclick="closePaymentModal()" class="w-1/3 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold py-3.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition text-sm">
                    Batal
                </button>
                <button onclick="processPayment()" id="btn-confirm-pay" class="w-2/3 bg-gradient-brand text-white font-bold py-3.5 rounded-full transition hover:opacity-90 shadow-lg shadow-blue-500/40 flex justify-center items-center gap-2 text-sm active:scale-95">
                    <span>Konfirmasi</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA MENU ---
        const MENU_ITEMS = [
            { id: 101, name: "Nasi Ayam Geprek Sambal Korek", category: "Nasi", price: 18000, img: "ðŸ”ðŸŒ¶ï¸", desc: "Pedas nampol!", tags: ["hot"] },
            { id: 102, name: "Nasi Ayam Crispy Telur", category: "Nasi", price: 20000, img: "ðŸ”ðŸ¥š", desc: "Ayam renyah + telur.", tags: [] },
            { id: 103, name: "Ayam Bakar Madu + Nasi", category: "Nasi", price: 22000, img: "ðŸ—ðŸ¯", desc: "Bumbu madu meresap.", tags: ["kids"] },
            { id: 104, name: "Nasi Gila Porsi Jumbo", category: "Nasi", price: 25000, img: "ðŸ¤ªðŸ›", desc: "Topping sosis bakso.", tags: ["warm"] },
            { id: 105, name: "Rice Bowl Ayam Teriyaki", category: "Nasi", price: 23000, img: "ðŸšðŸ—", desc: "Saus teriyaki gurih.", tags: [] },
            { id: 106, name: "Nasi Bebek Goreng Serundeng", category: "Nasi", price: 28000, img: "ðŸ¦†", desc: "Bebek empuk gurih.", tags: ["best"] },
            { id: 201, name: "Mie Yamin Manis Pedas", category: "Mie", price: 16000, img: "ðŸœðŸŒ¶ï¸", desc: "Kecap manis pedas.", tags: ["warm"] },
            { id: 202, name: "Spaghetti Brulee Creamy", category: "Mie", price: 24000, img: "ðŸðŸ§€", desc: "Saus bechamel lumer.", tags: ["kids"] },
            { id: 203, name: "Bakmi Ayam Jamur Komplit", category: "Mie", price: 21000, img: "ðŸ„ðŸœ", desc: "Topping jamur melimpah.", tags: ["warm"] },
            { id: 301, name: "Double Cheese Smash Burger", category: "Western", price: 32000, img: "ðŸ”ðŸ§€", desc: "Daging sapi & keju.", tags: ["best", "kids"] },
            { id: 302, name: "Chicken Mentai Rice", category: "Western", price: 28000, img: "ðŸ›", desc: "Saus mentai bakar.", tags: [] },
            { id: 303, name: "Fish and Chips Tartar Sauce", category: "Western", price: 35000, img: "ðŸŸðŸŸ", desc: "Ikan dori lembut.", tags: ["kids"] },
            { id: 304, name: "Beef Pepper Rice Hotplate", category: "Western", price: 38000, img: "ðŸ¥©ðŸ³", desc: "Nasi lada hitam.", tags: ["warm"] },
            { id: 402, name: "Dimsum Mentai (4 pcs)", category: "Snack", price: 18000, img: "ðŸ¥Ÿ", desc: "Saus mentai.", tags: ["best"] },
            { id: 405, name: "Kentang Goreng", category: "Snack", price: 19000, img: "ðŸŸ", desc: "Renyah gurih.", tags: ["kids"] },
            { id: 501, name: "Pisang Bakar Coklat Keju", category: "Snack", price: 13000, img: "ðŸŒðŸ«", desc: "Manis legit.", tags: [] },
            { id: 502, name: "Roti Bakar Coklat Keju", category: "Snack", price: 15000, img: "ðŸžðŸ«", desc: "Klasik topping.", tags: ["kids"] },
            { id: 601, name: "Kopi Susu Gula Aren", category: "Minuman", price: 18000, img: "â˜•", desc: "Creamy aren asli.", tags: ["cold", "best"] },
            { id: 602, name: "Es Coklat Klasik", category: "Minuman", price: 15000, img: "ðŸ«ðŸ¥¤", desc: "Coklat pekat.", tags: ["cold", "kids"] },
            { id: 603, name: "Lychee Tea", category: "Minuman", price: 20000, img: "ðŸ¹", desc: "Teh leci segar.", tags: ["cold"] },
            { id: 604, name: "Lemon Tea Dingin", category: "Minuman", price: 10000, img: "ðŸ‹ðŸ§Š", desc: "Segar dingin.", tags: ["cold"] },
            { id: 605, name: "Brown Sugar Boba Milk", category: "Minuman", price: 22000, img: "ðŸ§‹", desc: "Boba kenyal.", tags: ["cold"] },
            { id: 606, name: "Jus Alpukat Kocok", category: "Minuman", price: 17000, img: "ðŸ¥‘", desc: "Alpukat mentega.", tags: ["cold"] },
            { id: 607, name: "Air Mineral", category: "Minuman", price: 5000, img: "ðŸ’§", desc: "Dingin/Biasa.", tags: ["cold"] }
        ];

        // --- GLOBAL STATE ---
        let cart = [];
        let currentWeather = "sunny";
        let currentCategory = "All";
        let isDarkMode = false;
        let isCartOpen = false;
        let currentUser = null;
        
        // --- AUTH & STATE LOGIC ---
        let isRegisterMode = false; // False = Login, True = Register
        
        // Load user from DB (Simulation)
        function getUsersDB() {
            const db = localStorage.getItem('resto_users');
            return db ? JSON.parse(db) : {'admin': '123'}; // Default user admin:123
        }

        function saveUserToDB(username, password) {
            const db = getUsersDB();
            db[username] = password;
            localStorage.setItem('resto_users', JSON.stringify(db));
        }

        const formatRp = (num) => "Rp " + num.toLocaleString("id-ID");

        // --- AUTH FUNCTION UI ---
        function checkAuth() {
            if (!currentUser) {
                openAuthModal();
                return false;
            }
            return true;
        }

        function openAuthModal() {
            const modal = document.getElementById('auth-modal');
            const box = document.getElementById('auth-box');
            // Reset fields
            document.getElementById('auth-name-input').value = "";
            document.getElementById('auth-pass-input').value = "";
            
            modal.classList.remove('hidden'); modal.classList.add('flex');
            setTimeout(() => { box.classList.remove('scale-95', 'opacity-0'); box.classList.add('scale-100', 'opacity-100'); }, 10);
        }

        function closeAuthModal() {
            const modal = document.getElementById('auth-modal');
            const box = document.getElementById('auth-box');
            box.classList.remove('scale-100', 'opacity-100'); box.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');
            const btn = document.getElementById('btn-submit-auth');
            const switchText = document.getElementById('auth-switch-text');
            const switchBtn = document.getElementById('auth-switch-btn');
            const icon = document.getElementById('auth-icon');

            if (isRegisterMode) {
                // Change to Register UI
                title.innerText = "Buat Akun Baru";
                subtitle.innerText = "Isi data untuk mendaftar.";
                btn.innerText = "Daftar & Masuk";
                switchText.innerText = "Sudah punya akun?";
                switchBtn.innerText = "Masuk disini";
                icon.setAttribute('data-lucide', 'user-plus');
            } else {
                // Change to Login UI
                title.innerText = "Masuk Akun";
                subtitle.innerText = "Silakan masuk untuk mulai memesan.";
                btn.innerText = "Masuk Sekarang";
                switchText.innerText = "Belum punya akun?";
                switchBtn.innerText = "Buat Akun";
                icon.setAttribute('data-lucide', 'log-in');
            }
            lucide.createIcons();
        }

        function togglePasswordVisibility() {
            const passInput = document.getElementById('auth-pass-input');
            const eyeIcon = document.getElementById('eye-icon');
            
            if (passInput.type === "password") {
                passInput.type = "text";
                eyeIcon.setAttribute('data-lucide', 'eye-off');
            } else {
                passInput.type = "password";
                eyeIcon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        }

        function handleAuthAction() {
            const username = document.getElementById('auth-name-input').value.trim();
            const password = document.getElementById('auth-pass-input').value.trim();
            const db = getUsersDB();

            if (!username || !password) {
                alert("Harap isi Username dan Password!");
                return;
            }

            if (isRegisterMode) {
                // LOGIKA DAFTAR
                if (db[username]) {
                    alert("Username sudah terpakai! Silakan pilih yang lain.");
                } else {
                    saveUserToDB(username, password);
                    currentUser = username;
                    updateHeaderUI();
                    closeAuthModal();
                    alert(`âœ… Akun berhasil dibuat! Selamat datang, ${currentUser}.`);
                }
            } else {
                // LOGIKA LOGIN
                if (db[username] && db[username] === password) {
                    currentUser = username;
                    updateHeaderUI();
                    closeAuthModal();
                    alert(`ðŸ‘‹ Selamat datang kembali, ${currentUser}!`);
                } else {
                    alert("âŒ Username atau Password salah!");
                }
            }
        }

        function handleLogout() {
            if(confirm("Yakin ingin keluar akun?")) {
                currentUser = null;
                cart = []; // Reset keranjang saat logout
                updateCartUI();
                updateHeaderUI();
            }
        }

        function updateHeaderUI() {
            const btnAuth = document.getElementById('btn-auth');
            const userSection = document.getElementById('user-section');
            const userNameDisplay = document.getElementById('user-name');

            if (currentUser) {
                userSection.classList.remove('hidden');
                userSection.classList.add('flex');
                userNameDisplay.innerText = currentUser;
                btnAuth.innerText = "Keluar";
                btnAuth.setAttribute('onclick', 'handleLogout()');
                btnAuth.classList.replace('bg-white', 'bg-red-500');
                btnAuth.classList.replace('text-blue-600', 'text-white');
                btnAuth.classList.replace('hover:bg-blue-50', 'hover:bg-red-600');
            } else {
                userSection.classList.add('hidden');
                userSection.classList.remove('flex');
                btnAuth.innerText = "Masuk";
                btnAuth.setAttribute('onclick', 'openAuthModal()');
                btnAuth.classList.replace('bg-red-500', 'bg-white');
                btnAuth.classList.replace('text-white', 'text-blue-600');
                btnAuth.classList.replace('hover:bg-red-600', 'hover:bg-blue-50');
            }
        }

        // --- CART LOGIC ---
        function addToCart(id) {
            // CEK AUTH SEBELUM BELI
            if (!checkAuth()) return;

            const item = MENU_ITEMS.find(i => i.id === id);
            const existing = cart.find(i => i.id === id);
            if(existing) existing.qty++; else cart.push({...item, qty: 1});
            updateCartUI();
            openCart();
        }

        function changeQty(id, delta) {
            const item = cart.find(i => i.id === id);
            if (!item) return;
            item.qty += delta;
            if (item.qty <= 0) {
                cart = cart.filter(i => i.id !== id);
            }
            updateCartUI();
        }

        function clearCart() {
            if (cart.length > 0 && confirm("Batalkan semua pesanan?")) {
                cart = [];
                updateCartUI();
            }
        }

        function updateCartUI() {
            const badge = document.getElementById('cart-badge');
            const overlay = document.getElementById('cart-overlay');
            const items = document.getElementById('cart-items');
            const totalEl = document.getElementById('total-price');
            const totalBadge = document.getElementById('cart-total-badge');

            const qty = cart.reduce((a,b) => a + b.qty, 0);
            const price = cart.reduce((a,b) => a + (b.price * b.qty), 0);

            badge.innerText = qty;
            badge.classList.toggle('hidden', qty === 0);
            
            if(qty > 0) overlay.classList.remove('translate-y-full');
            else { overlay.classList.add('translate-y-full'); if(isCartOpen) toggleCartDrawer(); }

            items.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                    <div class="flex items-center gap-3 flex-1 overflow-hidden">
                        <div class="text-2xl">${item.img}</div>
                        <div class="truncate flex-1">
                             <h4 class="text-sm font-bold dark:text-white truncate">${item.name}</h4>
                             <div class="text-xs text-slate-500 dark:text-slate-400">${formatRp(item.price)}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 bg-white dark:bg-slate-700 rounded-lg p-1 border border-slate-200 dark:border-slate-600">
                        <button onclick="changeQty(${item.id}, -1)" class="w-6 h-6 flex items-center justify-center bg-slate-100 dark:bg-slate-600 rounded text-xs font-bold hover:bg-slate-200 dark:hover:bg-slate-500 transition">-</button>
                        <span class="text-sm font-bold w-4 text-center dark:text-white">${item.qty}</span>
                        <button onclick="changeQty(${item.id}, 1)" class="w-6 h-6 flex items-center justify-center bg-blue-500 text-white rounded text-xs font-bold hover:bg-blue-600 transition">+</button>
                    </div>
                </div>
            `).join('');

            totalEl.innerText = formatRp(price);
            totalBadge.innerText = `${qty} Item`;
        }

        // --- PAYMENT ---
        function openPaymentModal() {
            if(cart.length === 0) return alert("Keranjang masih kosong!");
            const modal = document.getElementById('payment-modal');
            const box = document.getElementById('payment-box');
            document.getElementById('modal-total-price').innerText = document.getElementById('total-price').innerText;
            modal.classList.remove('hidden'); modal.classList.add('flex');
            setTimeout(() => { box.classList.remove('scale-95', 'opacity-0'); box.classList.add('scale-100', 'opacity-100'); }, 10);
        }

        function closePaymentModal() {
            const modal = document.getElementById('payment-modal');
            const box = document.getElementById('payment-box');
            box.classList.remove('scale-100', 'opacity-100'); box.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
        }

        function processPayment() {
            const method = document.querySelector('input[name="payment"]:checked').value;
            const btn = document.getElementById('btn-confirm-pay');
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Memproses...`;
            btn.disabled = true;
            lucide.createIcons();
            setTimeout(() => {
                alert(`âœ… Pesanan Diterima a.n ${currentUser}!\nMetode: ${method}\nMohon tunggu pesanan Anda.`);
                cart = []; updateCartUI(); closePaymentModal();
                btn.innerHTML = `<span>Konfirmasi</span>`; btn.disabled = false;
            }, 1500);
        }

        // --- OTHER UI LOGIC ---
        function toggleDarkMode() {
            const html = document.documentElement;
            const icon = document.getElementById('icon-theme');
            isDarkMode = !isDarkMode;
            if (isDarkMode) { html.classList.add('dark'); icon.setAttribute('data-lucide', 'sun'); } 
            else { html.classList.remove('dark'); icon.setAttribute('data-lucide', 'moon'); }
            lucide.createIcons();
        }

        function toggleCartDrawer() {
            const itemsDiv = document.getElementById('cart-items');
            const chevron = document.getElementById('cart-chevron');
            isCartOpen = !isCartOpen;
            if(isCartOpen) { itemsDiv.classList.remove('hidden'); chevron.style.transform = "rotate(180deg)"; } 
            else { itemsDiv.classList.add('hidden'); chevron.style.transform = "rotate(0deg)"; }
        }
        
        function openCart() {
             const cartOverlay = document.getElementById('cart-overlay');
             cartOverlay.classList.remove('translate-y-full');
             if(!isCartOpen) toggleCartDrawer();
        }

        function renderMenu() {
            const grid = document.getElementById('menu-grid');
            const searchVal = document.getElementById('search-input').value.toLowerCase();
            grid.innerHTML = "";
            const filtered = MENU_ITEMS.filter(item => {
                const matchCat = currentCategory === "All" || item.category === currentCategory;
                const matchSearch = item.name.toLowerCase().includes(searchVal);
                return matchCat && matchSearch;
            });
            if (filtered.length === 0) { grid.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400">Menu tidak ditemukan.</div>`; return; }
            filtered.forEach(item => {
                grid.innerHTML += `
                    <div class="bg-white dark:bg-darkcard rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 overflow-hidden hover:shadow-md transition-all duration-300 group flex flex-col h-full relative py-4">
                        <div class="flex justify-center relative">
                            <div class="text-6xl drop-shadow-sm transition-transform group-hover:scale-110 cursor-default">${item.img}</div>
                            ${item.tags.includes('best') ? '<span class="absolute top-0 right-2 bg-yellow-400 text-yellow-900 text-[9px] font-bold px-1.5 py-0.5 rounded-full uppercase tracking-wider shadow-sm">Favorit</span>' : ''}
                        </div>
                        <div class="p-4 flex flex-col flex-grow relative text-center">
                            <h3 class="font-bold text-slate-800 dark:text-slate-100 text-sm leading-tight mb-1 line-clamp-2">${item.name}</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">${item.desc}</p>
                            <div class="mt-auto flex flex-col items-center gap-2">
                                <span class="font-extrabold text-blue-600 dark:text-sky-400 text-base">${formatRp(item.price)}</span>
                                <button onclick="addToCart(${item.id})" class="bg-blue-50 dark:bg-slate-700 text-blue-600 dark:text-sky-400 w-full py-2 rounded-xl flex items-center justify-center hover:bg-blue-600 hover:text-white dark:hover:bg-sky-500 dark:hover:text-white transition shadow-sm active:scale-95 text-xs font-bold gap-1 border border-blue-100 dark:border-slate-600">
                                    <i data-lucide="plus" class="w-4 h-4"></i> Tambah
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function filterCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                if(btn.innerText.includes(cat) || (cat === 'All' && btn.innerText === 'Semua')) {
                    btn.className = "cat-btn bg-gradient-brand text-white px-4 py-2 rounded-full text-xs font-bold shadow-md shadow-blue-200 dark:shadow-none transition transform scale-105 whitespace-nowrap";
                } else {
                    btn.className = "cat-btn bg-white dark:bg-darkcard text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-full text-xs font-medium whitespace-nowrap transition hover:border-blue-400 hover:text-blue-500";
                }
            });
            renderMenu();
        }

        function renderAI() {
            const container = document.getElementById('ai-container');
            container.innerHTML = "";
            let recs = [];
            if (currentWeather === "rainy") recs = MENU_ITEMS.filter(i => i.tags.includes("warm") || i.category === "Mie" || i.tags.includes("hot"));
            else recs = MENU_ITEMS.filter(i => i.tags.includes("cold") || i.tags.includes("best"));
            recs.sort(() => 0.5 - Math.random()).slice(0, 3).forEach((item, idx) => {
                container.innerHTML += `
                    <div class="bg-sky-50 dark:bg-slate-800/50 p-2 rounded-xl border border-sky-100 dark:border-slate-700 flex flex-col items-center gap-2 hover:bg-white dark:hover:bg-slate-700 transition cursor-pointer scale-in shadow-sm text-center" style="animation-delay: ${idx * 100}ms" onclick="addToCart(${item.id})">
                        <div class="relative"><div class="text-4xl">${item.img}</div><div class="absolute -top-1 -right-1 bg-gradient-brand text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold shadow-sm">AI</div></div>
                        <div><h3 class="font-bold text-xs dark:text-white leading-tight truncate w-full">${item.name}</h3><p class="text-xs text-blue-600 dark:text-sky-400 font-bold">${formatRp(item.price)}</p></div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function setWeather(weather) { currentWeather = weather; renderAI(); }

        document.getElementById('search-input').addEventListener('input', renderMenu);
        window.onload = () => { renderMenu(); renderAI(); lucide.createIcons(); };
    </script>
</body>
</html>